#KQL detection rules 
#Following rules were based on snapattack threat intel, you can find author/who discovered by following snapattack link
#These kibana query languague queries will be used to trigger alert in elastic security, which will then be notified thanks to free elastalert2


https://app.snapattack.com/threat/b861aedb-2f26-15de-5877-278a10746d55 - Threat: Registry Modification | Registry Creation | Enable Multiple RDP Sessions
(event.code : ("12" or "13" or "14") and (registry.path : (*HKLM*System*CurrentControlSet*Control*Terminal*Server*fSingleSessionPerUser*) and registry.data.strings : 0) or (registry.path : (*Policies*Microsoft*Windows*NT*Terminal*Services*AllowMultipleTSSessions*) and registry.data.strings : 1))

https://app.snapattack.com/detection/b3e50596-755b-4ed3-9981-c6c04d5de8ce
(event.code : "1" and process.command_line : ( (*dir*C*Users*.ssh*known_hosts*) or (*c*dir*C*users**appdata*roaming*Mozilla*firefox*profiles*) or (*c*mimikatz*) or (*reg*query*HKLM*Software*OpenSSH*) or (*reg*query*HKLM*Software*OpenSSH*Agent*) or (*reg*query*HKLM*Software*RealVNC*) or (*c*reg*query*HKLM*Software*RealVNC*VNCServer*) or (*c*reg*query*HKLM*Software*RealVNC*AllUsers*) or (*reg*query*HKLM*Software*RealVNC*AllUsers*VNCServer*) or (*reg*query*HKCU*Software**PuTTY*Session*) or (*reg*save*HKLM*SAM*ss.dat*) or (*reg*save*HKLM*System*sy.dat*)))

https://app.snapattack.com/detection/d4743bdc-33b1-4926-abff-44be0421d536 mshta execution of remote file or script
event.code : "1" and process.command_line : (*mshta*http*)

https://app.snapattack.com/detection/74049c99-9227-49e0-b29c-d0264a2589bf | Malware Dridex Dropper Doc 20191217
process.command_line : *powershell -w hidden -en jabf* or powershell.file.script_block_text : *-w hidden -en jabf*

https://app.snapattack.com/detection/e944da96-f3fa-4d1c-8974-6d34ce49657b | Malware Servhelper Bot
process.command_line : ((*net*user*wgautilacc*) or (*net*localgroup*remote*desktop*users*)) OR powershell.file.script_block_text : ((*net*user*wgautilacc*) or (*net*localgroup*remote*desktop*users*))

https://www.cisa.gov/sites/default/files/publications/aa22-320a_joint_csa_iranian_government-sponsored_apt_actors_compromise_federal%20network_deploy_crypto%20miner_credential_harvester.pdf | iranian apt Crypto
Miner, Credential Harvester
powershell.file.script_block_text : ((*try*AddMpPreference*ExclusionPath*WriteHost*added*
exclusion*catch*WriteHost*addingexclusionfailed*powershell*enc*) OR (*getadcomputer*filter*properties*select*name,operatingsystem,ipv4address* )) OR (event.code: 11 and file.path : ((*XMRig*) or (*Ngrok*))) OR (event.code: 22 and dns.question.name : ((*us.ngrok.*) or (*korgn.su.lennut*)))

https://app.snapattack.com/detection/432c950f-4974-459e-8849-bcb17b8b9a65 `| NoLMHash registry setting is disabled
event.code : ("12" or "13" or "14") and registry.path : (*System*CurrentControlSet*Control*Lsa*NoLmHash*)

https://app.snapattack.com/detection/a3df9342-c912-4480-bbcc-62a7ed4d467f | suspicious enumeration of kerberos ticket
event.code : "1" and process.executable.text : klist.exe and process.parent.name : (*powershell.exe* or *cmd.exe*)

https://app.snapattack.com/detection/bb27e968-9bd2-4bb5-a97b-9e8dd5ec4a33 | NoChangingWallPaper
event.code : ("12" or "13" or "14") and (registry.path : (*Software*Microsoft*Windows*CurrentVersion*Policies*ActiveDesktop*NoChangingWallPaper*))

https://app.snapattack.com/detection/8bccbf9e-82eb-4692-b42f-8a95cc7d22f7 | GPP password lookup
event.code : "1" and process.command_line :  (*findstr*cpassword *.xml)

https://app.snapattack.com/detection/312562bb-c609-4df1-addc-60793e0f9c13 | Execution Compiled HTML File Decompile
event.code : "1" and process.name : hh.exe and process.command_line : (*-decompile*)

https://app.snapattack.com/detection/cb629ef1-df47-4901-b96e-15833a3ed2d2 | weird msdtc.exe execution
event.code : "1" and process.name : "msdtc.exe" and process.command_line : ((* -a*) or (*-b*))

https://app.snapattack.com/detection/61a6b350-f7d0-4e5e-bb9c-5436e6a44075 | check for cached domain credentials
event.code : "1" and process.command_line : (reg*query*HKLM*SOFTWARE*Microsoft*Windows*NT*CurrentVersion*Winlogon*v*CachedLogonsCount*)

https://app.snapattack.com/detection/de14ffcb-d948-46d9-a948-7030a777266e | hidden rundll through msiexec 
event.code: "1" and process.parent.name : "msiexec.exe" and process.command_line : ((*rundll32*) and (*HideWindow*))

https://app.snapattack.com/detection/60ebe63b-3eeb-4ec6-b5ac-71e53f1c35a3 | Potential use of certify 
powershell.file.script_block_text : ((*find*) and ((*vulnerable*) or (*enrolleeSuppliesSubject*) or (*json*outfile*))) or process.command_line : ((*find*) and ((*vulnerable*) or (*enrolleeSuppliesSubject*) or (*json*outfile*)))

https://app.snapattack.com/detection/821d40e4-8cd2-4dac-afbd-5c79b28e179a | Powerview ad enumeration offensive tool
event.code : "4104" and powershell.file.script_block_text : *Get-DomainGroupMember* or (event.code : 1 and process.command_line : (*Get-DomainGroupMember*))
